<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Simon Kucharsky" />

<meta name="date" content="2022-03-14" />

<title>Automatic verified tests using jaspTools</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Automatic verified tests using
jaspTools</h1>
<h4 class="author">Simon Kucharsky</h4>
<h4 class="date">2022-03-14</h4>



<div id="the-problem" class="section level2">
<h2>The problem</h2>
<p>We have a bunch of verified unit tests in the book by Jonas, but
currently, we need to manually specify new verified unit tests both in
the book and in the module. This is doubling the work and increasing the
changes that the book and the actuall state of the modules get
de-synchronized.</p>
</div>
<div id="proposal-solution" class="section level2">
<h2>Proposal solution</h2>
<p>Add new features to <code>jaspTools</code> that help R programmers
write verified unit tests. The code is then used both in the module
itself, as well as for generating the chapters in the verification
book.</p>
<p>I wrote a quick implementation. You can download my branch of
<code>jaspTools</code> that contains the functionality:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I am not running this in the .Rmd file so that I don&#39;t screw with people&#39;s jaspTools</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;kucharssim/jaspTools@upgradeTests&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jaspTools)</span></code></pre></div>
<pre><code>## jaspTools needs to be setup, so it can find all the resources it needs. Please use `setupJaspTools()` (you don&#39;t have to provide args if you&#39;re not sure what they mean).</code></pre>
<div id="create-a-verified-example" class="section level3">
<h3>1) Create a verified example</h3>
<p>The first step would be to create a verified example. This example is
meant to be human-readable, possibly with screenshots from other
programs for comparison, references, etc. So we will make the example as
an .Rmd file.</p>
<p><code>jaspTools</code> can then provide tools to make that file. The
function <code>useTestVignette</code> takes two main arguments:
<code>analysis</code> which is a string which tells the function which
analysis is tested in this example, and <code>name</code> which takes
the name of the example.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>jaspTools<span class="sc">::</span><span class="fu">useTestVignette</span>(<span class="at">analysis =</span> <span class="st">&quot;Descriptives&quot;</span>, <span class="at">name =</span> <span class="st">&quot;Sleep dataset&quot;</span>)</span></code></pre></div>
<pre><code>✓ Setting active project to &#39;/Users/skuchar/JASP/Develop/jaspModules/jaspDescriptives&#39;
✓ Adding &#39;knitr&#39; to Suggests field in DESCRIPTION
✓ Setting VignetteBuilder field in DESCRIPTION to &#39;knitr&#39;
✓ Creating &#39;vignettes/tests/&#39;
✓ Adding &#39;^vignettes/tests$&#39; to &#39;.Rbuildignore&#39;
✓ Adding &#39;inst/doc&#39; to &#39;.gitignore&#39;
✓ Writing &#39;vignettes/tests/descriptives-sleep-dataset.Rmd&#39;
• Modify &#39;vignettes/tests/descriptives-sleep-dataset.Rmd&#39;</code></pre>
<p>This function creates a vignette under <code>vignettes/tests/</code>
in the active <code>jaspModule</code> project, and fills it with some
basic structure that helps the R programmers create the example.
Optionally, if <code>open</code> argument is set to true, the vignette
is automatically opened in the developer’s text editor. The template is
stored in the <code>jaspTools</code> package, and automatically formats
the basic example to fit the context of the active module and the
specified analysis.</p>
<p>The most important part of the template is this:</p>
<pre><code>### JASP results

The analysis can be run as follows:

\```{r run-analysis, purl = TRUE}
results &lt;- jaspDescriptives::Descriptives(data = data)
\```


&lt;!-- Write here unit tests --&gt;

\```{r unit-tests, purl = TRUE}
testthat::test_that(&quot;Sleep dataset works&quot;, {
  # jaspTools::expect_jasp_table(results[[&quot;mainTable&quot;]])
  # jaspTools::expect_jasp_plot (results[[&quot;mainPlot&quot;]] )
})
\```</code></pre>
<p>The generated <code>run-analysis</code> code chunk shows how to run
the analysis in R. The <code>unit-tests</code> code chunk defines unit
tests. Both chunks specify <code>purl = TRUE</code>, which will be
important for running the tests in the current vignette as a unit test
for the package.</p>
<p>The template relies on two assumptions:</p>
<ol style="list-style-type: decimal">
<li><p>The analysis can be already run in syntax mode, not using
<code>jaspTools</code>. That is why in
<code>jaspDescriptives::Descriptives(data = data)</code> we use the
<code>data</code> argument, not the <code>dataset</code> argument. The
reason for this is that the code will be visible in the verification
book, and so we can also use this as a resource for people to look up
specific examples on how to run a JASP analysis in R. Additionally, the
tests then also serve as a test of the syntax layer, giving us a better
coverage of the functions people will use in R.</p></li>
<li><p>There will be two new functions,
<code>jaspTools::expect_jasp_table()</code> and
<code>jaspTools::expect_jasp_plot()</code>. The idea is that they will
utilize the snapshot functionality of the 3rd edition of
<code>testthat</code>. We already use snapshot testing for figures, but
now we can also use it for tables, with <code>expect_jasp_table()</code>
being a thin wrapper around <code>testthat::expect_snapshot()</code>.
Technically, we would not need to implement
<code>jaspTools::expect_jasp_plot()</code>, but it seems to be nice for
consistency.</p></li>
</ol>
<p>For the purpose of this example, I just added the following test:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;Sleep dataset works&quot;</span>, {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_snapshot</span>(<span class="fu">data.frame</span>(<span class="at">variable =</span> <span class="st">&quot;contNormal&quot;</span>, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">mean     =</span> <span class="fl">0.3434533231256709235</span>, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">sd       =</span> <span class="fl">0.3434533231256709235</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
</div>
<div id="test-the-vignette" class="section level3">
<h3>2) Test the vignette</h3>
<p><code>jaspTools</code> provides a function to run the vignette as a
test file. It is recommended to run this function once the vignette is
made. If snapshot testing is used, this will generate the snapshots that
we will be testing in the future. The snapshots will be created under
<code>tests/testthat/_snaps/</code> folder.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>jaspTools<span class="sc">::</span><span class="fu">testVignette</span>(<span class="st">&quot;descriptives-sleep-dataset&quot;</span>)</span></code></pre></div>
<pre><code>══ Testing test-vignette-descriptives-sleep-dataset.R ═════════════════════════════════════════════════════════════════════════════════════
[ FAIL 0 | WARN 1 | SKIP 0 | PASS 1 ]

── Warning (test-vignette-descriptives-sleep-dataset.R:13:3): Sleep dataset works ─────────────────────
Adding new snapshot:
Code
  data.frame(variable = &quot;contNormal&quot;, mean = 0.343453323125671, sd = 0.343453323125671)
Output
      variable      mean        sd
  1 contNormal 0.3434533 0.3434533</code></pre>
<p>And this is how the generated snapshot looks:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(<span class="fu">readLines</span>(usethis<span class="sc">::</span><span class="fu">proj_path</span>(<span class="st">&quot;tests/testthat/_snaps/vignette-descriptives-sleep-dataset.md&quot;</span>)))</span></code></pre></div>
<pre><code>## ✓ Setting active project to &#39;/Users/skuchar/JASP/Develop/jaspModules/jaspDescriptives&#39;</code></pre>
<pre><code>## # Sleep dataset works
## 
##     Code
##       data.frame(variable = &quot;contNormal&quot;, mean = 0.343453323125671, sd = 0.343453323125671)
##     Output
##           variable      mean        sd
##       1 contNormal 0.3434533 0.3434533</code></pre>
<p>After verifying this output, the test vignette is finished.</p>
<p>Running the tests in the vignette can be done again by running
<code>jaspTools::testVignette(&quot;descriptives-sleep-dataset&quot;)</code>.
Alternatively, we can run <code>jaspTools::testVignettes()</code>
function, which can take an optional argument <code>analysis</code>. If
the argument is left empty, all test vignettes will be tested.
Otherwise, only vignettes associated with the specific analysis will be
tested.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>jaspTools<span class="sc">::</span><span class="fu">testVignettes</span>()</span></code></pre></div>
<pre><code>## Warning: package &#39;testthat&#39; was built under R version 4.1.2</code></pre>
<pre><code>## ✓ | F W S  OK | Context
## 
⠏ |         0 | vignette-descriptives-sleep-dataset                                                                                                   
⠋ |         1 | vignette-descriptives-sleep-dataset                                                                                                   
✓ |         1 | vignette-descriptives-sleep-dataset [0.2s]
## 
## ══ Results ═══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════
## Duration: 0.2 s
## 
## [ FAIL 0 | WARN 0 | SKIP 0 | PASS 1 ]</code></pre>
<p>Plan: Integrate vignette testing with
<code>jaspTools::testAnalysis()</code> and
<code>jaspTools::testAll()</code> functions.</p>
</div>
<div id="using-the-test-vignette" class="section level3">
<h3>3) Using the test vignette</h3>
<p>The outcome of this that for each verified example, we have a single
source, inside of <code>vignettes/tests/</code>.</p>
<p>We can automatically knit and insert the vignette into the
verification project. So with this setup, we have three purposes for a
single vignette file:</p>
<ol style="list-style-type: decimal">
<li>Document that the JASP analysis is correct</li>
<li>Demonstrate how to use an R Syntax to run the analysis</li>
<li>Use the example in the vignette as a source for unit-testing in the
module itself</li>
</ol>
</div>
<div id="things-to-resolve" class="section level3">
<h3>Things to resolve</h3>
<ul>
<li><p>Where should example data sets live? Currently, we just put them
in the <code>tests/testthat/</code> folder, but it seems to me that if
we generate vignettes using these data sets, we should put them properly
inside of the module under <code>data/*.Rdata</code>, or
<code>inst/extdata/*.csv</code>. Then, the vignettes can show the users
how to get the data we used for testing much easier.</p></li>
<li><p>I have not looked into integrating vignette testing with
<code>jaspTools::testAll()</code>. Currently, all functionality I
quickly wrote now followed conventional assumptions for package
development according to the <code>usethis</code> package (wrt working
directory and active projects, etc.). <code>jaspTools</code> in general
however does not follow that convention (e.g., it is possible to run
<code>jaspTools::testAnalysis(&quot;Descriptives&quot;)</code> even when the
working directory is not inside of the <code>jaspDescriptives</code>
project). Further, the current code assumes that the tests always run on
a source package, not an installed package. Are there any use cases
where we need this? That is, do we ever run the tests from outside of
the module, and do we ever run the unit tests as an installed package,
not as a source package?</p></li>
</ul>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
